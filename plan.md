# Complete Migration Guide: Supabase to Self-Hosted BackendThis guide documents **everything** your Supabase project uses so you can replicate it on your own server (PostgreSQL + NestJS/Directus or any backend).---## 1. Database Schema (15 Tables)All tables use UUID primary keys with `gen_random_uuid()` defaults and `created_at` timestamps.| Table | Purpose | Key Columns ||-------|---------|-------------|| `admin_credentials` | Admin login (bcrypt hashed) | email, password_hash || `legal_cases` | Main case submissions | full_name, email, phone, address, category, legal_problem, legal_questions, pricing_plan, payment_method, payment_status, service_request_id, payment_tracking_id, files (jsonb), payment_files (jsonb) || `legal_petitions` | Legal petition requests | full_name, client_status, judicial_authority, case_type, facts_summary, legal_requests, files (jsonb), payment_status, user_id || `consultation_reservations` | Consultation bookings | full_name, email, phone, address, subject, description, reservation_date/time, duration_hours, total_price, platform_commission, payment_method, payment_proof_url, payment_status, status, consultant_id, user_id, service_request_id, payment_tracking_id, meeting_link || `consultants` | Available consultants | full_name, specialization, bio, photo_url, hourly_rate, is_available || `payment_credentials` | Temp login creds for payment pages | username, password (plaintext), case_id, page_type, is_used, used_at, expires_at || `doc_users` | Document pack subscribers | full_name, username, email, password_hash (bcrypt), is_active, payment_status || `pack_documents` | Paid document files | title, description, file_path, file_name, file_type, category, is_active || `educational_documents` | Free educational docs | year, semester, module, file_name, file_path, file_type, file_size, file_data (bytea), downloads || `faq_items` | FAQ entries | question, answer || `guidance_instructions` | How-to instructions | instruction_text, order_number, is_active || `verification_codes` | Email OTP codes | email, code, expires_at, used, used_at || `otp_attempts` | Brute-force tracking | email, success, attempted_at || `user_roles` | Role assignments (Google users) | user_id (UUID), role (enum: free_user, admin) || `premium_users` | Premium Google users | user_id, full_name, phone, username || `laws` | Legal texts | code, title, description, category, publication_date || `law_articles` | Articles within laws | law_id (FK), article_number, title, content || `case_formats` | Pro-format/final docs per case | case_id, proformat_file_path/name, proformat_accepted, final_format_file_path/name || `case_evaluations` | Case rating feedback | case_id, rating, proposition || `deletion_requests` | GDPR-style deletion requests | email, status |**Custom Enum Type**: `app_role` = ('free_user', 'admin')**Extension Required**: `pgcrypto` (for `crypt()` and `gen_salt()` used in bcrypt hashing)---## 2. Database Functions (RPCs) to Replicate as API EndpointsThese are currently called from the frontend via `supabase.rpc()`. Each needs a corresponding REST API endpoint.| RPC Function | HTTP Method | Auth Required | Purpose ||-------------|-------------|---------------|---------|| `verify_admin_login(email, password)` | POST | No | Validates admin credentials with bcrypt || `check_is_admin()` | GET | Yes (session) | Checks if current user is admin || `change_admin_password(old, new)` | POST | Yes (admin) | Updates admin bcrypt hash || `get_legal_cases_admin()` | GET | Yes (admin) | Returns all legal cases || `get_legal_case_by_id(case_id, email)` | GET | No | Returns case if email matches || `submit_legal_petition(...)` | POST | No | Creates a legal petition || `validate_payment_credential(user, pass)` | POST | No | Validates temp payment login || `mark_credential_used(id)` | POST | No | Marks credential as used || `create_payment_credential_admin(...)` | POST | Yes (admin) | Creates temp credentials || `get_payment_credentials_admin()` | GET | Yes (admin) | Lists all credentials || `delete_payment_credential_admin(id)` | DELETE | Yes (admin) | Deletes a credential || `update_payment_status_admin(case_id, status)` | POST | Yes (admin) | Updates payment status || `hash_password(plain)` | POST | No | Returns bcrypt hash || `verify_doc_user_login(email, password)` | POST | No | Validates doc user login || `get_pack_documents_for_doc_user(user_id, email)` | GET | Custom auth | Returns pack documents for verified user || `get_case_format_by_case(case_id, email)` | GET | No (email verified) | Returns case format docs || `accept_proformat_by_case(case_id, email)` | POST | No (email verified) | Marks proformat as accepted || `increment_document_downloads(doc_id)` | POST | No | Increments download counter || `generate_service_request_id(phone, date)` | Internal | N/A | Generates tracking IDs || `generate_payment_tracking_id(...)` | Internal | N/A | Generates payment IDs || `cleanup_expired_verification_codes()` | Internal | N/A | Housekeeping || `cleanup_old_otp_attempts()` | Internal | N/A | Housekeeping |---## 3. Edge Functions to Replicate as API EndpointsThese are serverless Deno functions. Convert them to Express/NestJS controllers.### 3.1 `send-booking-otp`- **Trigger**: POST from consultation booking form- **Dependencies**: Brevo API (email), Cloudflare Turnstile, PostgreSQL- **Logic**: Validates Turnstile token, rate-limits (3 OTPs/email/10min), generates 6-digit OTP, stores in `verification_codes`, sends HTML email via Brevo API- **Secrets needed**: `BREVO_API_KEY`, `TURNSTILE_SECRET_KEY`### 3.2 `verify-booking-otp`- **Trigger**: POST from OTP verification form- **Dependencies**: PostgreSQL- **Logic**: Brute-force protection (5 attempts/10min), validates OTP against `verification_codes`, marks as used, logs attempt in `otp_attempts`### 3.3 `submit-legal-case`- **Trigger**: POST from case submission form- **Dependencies**: Cloudflare Turnstile, Telegram Bot API, PostgreSQL- **Logic**: Turnstile verification, input validation (email, phone, disposable email blocking), rate limit (5/email/day), generates service_request_id and payment_tracking_id, inserts into `legal_cases`, sends Telegram notification- **Secrets needed**: `TURNSTILE_SECRET_KEY`, `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`### 3.4 `submit-consultation-reservation`- **Trigger**: POST from consultation booking- **Dependencies**: Telegram Bot API, PostgreSQL- **Logic**: Input validation, generates tracking IDs, inserts into `consultation_reservations`, sends Telegram notification- **Secrets needed**: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`### 3.5 `send-telegram-notification`- **Trigger**: POST from various frontend pages (legal petitions, doc signups, deletions, admin actions)- **Dependencies**: Telegram Bot API- **Logic**: Formats Arabic notification messages, supports multiple chat IDs, Markdown with fallback- **Secrets needed**: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID` (or `TELEGRAM_CHAT_IDS`)### 3.6 `upload-consultation-proof`- **Trigger**: POST from payment proof upload- **Dependencies**: Supabase Storage (replace with local filesystem or S3)- **Logic**: Receives base64-encoded file (max ~6MB), sanitizes filename, uploads to `consultation-proofs` bucket, returns signed URL---## 4. Storage Buckets to Replicate| Bucket | Public? | Purpose | Used By ||--------|---------|---------|---------|| `case-files` | Yes | Legal case attachments | LegalPetitionsPage, LegalCaseFileViewer || `educational-documents` | Yes | Free educational PDFs | FreeDashboard, DocsPage || `consultation-proofs` | No (private) | Payment proof images | upload-consultation-proof edge function || `payment-files` | No (private) | Payment file uploads | PaymentPage || `case-format-files` | No (private) | Pro-format and final docs | CaseFormatUploader (admin), ConsultationPage (user) |For self-hosted: use local filesystem with Express static serving (public) or signed URL middleware (private), or MinIO as an S3-compatible alternative.---## 5. Authentication SystemThe project has **three separate auth systems**:1. **Google OAuth (Supabase Auth)** - For free/premium plan users   - Users sign in via Google, get `free_user` role auto-assigned   - Session managed by Supabase Auth with 24-hour timeout   - **Replacement**: Passport.js with Google OAuth2 strategy + JWT sessions2. **Admin Auth (Custom)** - For admin dashboard   - Email/password login verified against `admin_credentials` (bcrypt)   - Also creates a Supabase Auth session for RLS   - **Replacement**: Simple JWT-based login endpoint with bcrypt verification3. **Doc User Auth (Custom)** - For document pack users   - Email/password verified via `verify_doc_user_login` RPC (bcrypt)   - Session stored in sessionStorage   - **Replacement**: JWT-based login endpoint4. **Payment Credential Auth (Custom)** - Temporary access tokens   - Username/password verified via `validate_payment_credential` RPC (plaintext)   - One-time use with expiry   - **Replacement**: Simple token validation endpoint---## 6. Frontend Changes RequiredAfter setting up your backend, you need to update **every file that imports from `@/integrations/supabase/client`**:| Current Pattern | Replace With ||----------------|-------------|| `supabase.rpc('function_name', params)` | `fetch('/api/function-name', { method: 'POST', body: JSON.stringify(params) })` || `supabase.functions.invoke('edge-fn', { body })` | `fetch('/api/edge-fn', { method: 'POST', body: JSON.stringify(body) })` || `supabase.from('table').select()` | `fetch('/api/table')` || `supabase.from('table').delete().eq('id', x)` | `fetch('/api/table/${x}', { method: 'DELETE' })` || `supabase.storage.from('bucket').upload(...)` | `fetch('/api/upload/bucket', { method: 'POST', body: formData })` || `supabase.storage.from('bucket').download(...)` | `fetch('/api/files/bucket/path')` || `supabase.auth.signInWithOAuth(...)` | Redirect to `/auth/google` || `supabase.auth.signInWithPassword(...)` | `fetch('/api/auth/login', ...)` || `supabase.auth.signOut()` | `fetch('/api/auth/logout', ...)` || `supabase.auth.getUser()` | `fetch('/api/auth/me')` || `supabase.auth.onAuthStateChange(...)` | Custom auth context with JWT token check |**Files to modify** (13 files):- `src/integrations/supabase/client.ts` (replace entirely)- `src/contexts/AuthContext.tsx`- `src/pages/AdminLogin.tsx`- `src/pages/AdminCasesPage.tsx`- `src/pages/PaymentPage.tsx`- `src/pages/PaymentLoginPage.tsx`- `src/pages/ConsultationLoginPage.tsx`- `src/pages/ConsultationPage.tsx`- `src/pages/ConsultationBookingPage.tsx`- `src/pages/FreeDashboard.tsx`- `src/pages/DocsPlanPage.tsx`- `src/pages/DocsDashboard.tsx`- `src/pages/LegalPetitionsPage.tsx`- `src/pages/Index.tsx`- `src/components/admin/CredentialsManager.tsx`- `src/components/admin/ChangePasswordForm.tsx`- `src/components/admin/CaseFormatUploader.tsx`- `src/components/case/LegalCaseFileViewer.tsx`---## 7. Environment Variables / Secrets Needed on Your Server| Secret | Purpose ||--------|---------|| `DATABASE_URL` | PostgreSQL connection string || `JWT_SECRET` | For signing auth tokens || `BREVO_API_KEY` | Email sending (OTP) || `TURNSTILE_SECRET_KEY` | Cloudflare bot protection || `TELEGRAM_BOT_TOKEN` | Telegram notifications || `TELEGRAM_CHAT_ID` | Telegram recipient || `GOOGLE_CLIENT_ID` | Google OAuth || `GOOGLE_CLIENT_SECRET` | Google OAuth |---## 8. Recommended Self-Hosted Stack**Option A: NestJS (full control)**- PostgreSQL (same schema, direct migration)- NestJS with TypeORM or Prisma- Passport.js for auth (Google OAuth + JWT)- Multer for file uploads, local disk or MinIO for storage- Node-cron for cleanup jobs**Option B: Directus (faster setup)**- PostgreSQL (same schema)- Directus auto-generates REST API + admin panel- Custom endpoints for business logic (OTP, Telegram, Turnstile)- Built-in auth system with JWT- Built-in file storage---## 9. Migration Steps (What You Need To Do)1. **Export your database**: Run `pg_dump` on your Supabase PostgreSQL or use the SQL Editor to export schema + data2. **Set up PostgreSQL** on your server and import the dump3. **Install pgcrypto extension**: `CREATE EXTENSION IF NOT EXISTS pgcrypto;`4. **Build your API layer** (NestJS or Directus) implementing all endpoints from sections 2-35. **Set up file storage** (local filesystem or MinIO)6. **Configure Google OAuth** credentials for your new domain7. **Set up Cloudflare Turnstile** with your new domain8. **Provide your new API base URL** so I can update all frontend code to point to it---## What I Can DoOnce your backend is running and you give me the API base URL, I can:- Replace the Supabase client with a generic HTTP client (fetch/axios)- Update all 18+ frontend files to call your new API endpoints- Update the auth context to use JWT-based auth- Update file upload/download logic for your storage solution